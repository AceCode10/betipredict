// Prisma schema for BetiPredict - PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String   @id @default(cuid())
  email                   String   @unique
  password                String?
  phone                   String?  @unique
  username                String   @unique
  fullName                String
  avatar                  String?
  balance                 Float    @default(0)
  isVerified              Boolean  @default(false)
  verificationToken       String?  @unique
  verificationTokenExpiry DateTime?
  resetPasswordToken      String?  @unique
  resetPasswordExpiry     DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  orders                  Order[]
  positions               Position[]
  transactions            Transaction[]
  mobilePayments          MobilePayment[]
  marketCreations         Market[]
  suggestions             MarketSuggestion[] @relation("UserSuggestions")
  reviewedSuggestions     MarketSuggestion[] @relation("AdminReviews")
  notifications           Notification[]
  settings                UserSettings?

  @@map("users")
}

model Market {
  id             String    @id @default(cuid())
  title          String
  description    String?
  category       String
  subcategory    String?
  question       String    @unique
  yesPrice       Float     @default(0.5)
  noPrice        Float     @default(0.5)
  volume         Float     @default(0)
  liquidity      Float     @default(0)
  status         String    @default("PENDING")
  resolveTime    DateTime
  resolvedAt     DateTime?
  winningOutcome String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  creatorId      String
  creator        User      @relation(fields: [creatorId], references: [id])
  orders         Order[]
  positions      Position[]

  @@map("markets")
}

model Order {
  id            String   @id @default(cuid())
  type          String   @default("LIMIT")
  side          String
  outcome       String
  price         Float
  amount        Float
  filled        Float    @default(0)
  remaining     Float
  status        String   @default("OPEN")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        String
  user          User     @relation(fields: [userId], references: [id])
  marketId      String
  market        Market   @relation(fields: [marketId], references: [id])

  @@map("orders")
}

model Position {
  id            String   @id @default(cuid())
  outcome       String
  size          Float
  averagePrice  Float
  unrealizedPnl Float    @default(0)
  realizedPnl   Float    @default(0)
  isClosed      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        String
  user          User     @relation(fields: [userId], references: [id])
  marketId      String
  market        Market   @relation(fields: [marketId], references: [id])

  @@unique([userId, marketId, outcome])
  @@map("positions")
}

model Transaction {
  id            String   @id @default(cuid())
  type          String
  amount        Float
  feeAmount     Float    @default(0)
  description   String
  status        String   @default("PENDING")
  metadata      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  @@map("transactions")
}

// Mobile money payments (Airtel Money deposits & withdrawals)
model MobilePayment {
  id                String   @id @default(cuid())
  type              String   // DEPOSIT or WITHDRAWAL
  amount            Float    // Gross amount in Kwacha
  feeAmount         Float    @default(0) // Platform fee
  netAmount         Float    // Amount after fees
  phoneNumber       String   // Masked phone number (097****567)
  provider          String   @default("AIRTEL_MONEY") // Payment provider
  externalRef       String   @unique // Our reference sent to Airtel (BP-DEP-xxx)
  externalId        String?  // Airtel's transaction ID
  status            String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  statusMessage     String?
  callbackReceived  Boolean  @default(false)
  callbackData      String?  // Raw callback JSON for audit
  expiresAt         DateTime // Payment expires after 5 minutes
  completedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  userId            String
  user              User     @relation(fields: [userId], references: [id])

  @@index([externalRef])
  @@index([userId, type, status])
  @@index([status, expiresAt])
  @@map("mobile_payments")
}

// Platform revenue tracking (all fees collected)
model PlatformRevenue {
  id            String   @id @default(cuid())
  feeType       String   // TRADE_FEE, WITHDRAWAL_FEE, MARKET_CREATION_FEE, RESOLUTION_FEE
  amount        Float    // Fee amount in Kwacha
  description   String
  sourceType    String   // TRADE, WITHDRAWAL, MARKET_CREATION, RESOLUTION
  sourceId      String?  // Reference to the source record (order ID, payment ID, etc.)
  userId        String?  // User who paid the fee (null for system-generated)
  createdAt     DateTime @default(now())

  @@index([feeType])
  @@index([createdAt])
  @@map("platform_revenue")
}

// Scheduled games fetched from sports API (football-data.org)
model ScheduledGame {
  id              String   @id @default(cuid())
  externalId      Int      @unique // API's match ID
  competition     String   // e.g. "Premier League", "La Liga"
  competitionCode String   // e.g. "PL", "PD"
  homeTeam        String
  homeTeamCrest   String?
  awayTeam        String
  awayTeamCrest   String?
  matchday        Int?
  utcDate         DateTime // Scheduled kickoff time
  status          String   // SCHEDULED, LIVE, FINISHED, POSTPONED
  homeScore       Int?
  awayScore       Int?
  winner          String?  // HOME_TEAM, AWAY_TEAM, DRAW, null
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  marketId        String?  @unique // Link to market if one was created
  
  @@map("scheduled_games")
}

// Market suggestions submitted by users (requires admin approval)
model MarketSuggestion {
  id              String   @id @default(cuid())
  title           String
  description     String?
  category        String
  question        String
  resolutionSource String? // How to verify the outcome
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  suggesterId     String
  suggester       User     @relation("UserSuggestions", fields: [suggesterId], references: [id])
  reviewedById    String?
  reviewedBy      User?    @relation("AdminReviews", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  marketId        String?  @unique // Link to market if approved and created

  @@map("market_suggestions")
}

// User notifications
model Notification {
  id          String   @id @default(cuid())
  type        String   // MARKET_RESOLVED, BET_WON, BET_LOST, SUGGESTION_APPROVED, SUGGESTION_REJECTED, DEPOSIT, WITHDRAW
  title       String
  message     String
  isRead      Boolean  @default(false)
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

// User settings (dark mode, etc.)
model UserSettings {
  id          String   @id @default(cuid())
  darkMode    Boolean  @default(true)
  language    String   @default("en")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])

  @@map("user_settings")
}
